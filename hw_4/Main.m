clear
close all

%% FANUC R-2000iC/165F
% links
global l1 l2 l3 l4 l5 l6

l1 = 670; 
l2 = 312;
l3 = 1075;
l4 = 225;
l5 = 1280;
l6 = 215;
% angles
syms q1 q2 q3 q4 q5 q6 real

%number of experiments
c = 30;

%% irreducible model

%design 30 experiments for angles
q = [rand(1,c)*pi*370/90 - 370/180*pi; rand(1,c)*pi*136/90 - 136/180*pi; ...
    rand(1,c)*pi*312/90 - 312/180*pi;rand(1,c)*pi*720/90 - 720/180*pi;  ...
    rand(1,c)*pi*250/90 - 250/180*pi; rand(1,c)*pi*720/90 - 720/180*pi];
q = q';

%T irreducible :
% ang_err = 1/180*pi + (3/180*pi)*rand(3,1)
% T = [Tx*Ty*Tz]*
% Rz(q1 + ang_err(1))*[Tx*Ty*Ry]*
% Rx(q2 + ang_err(2))*[Ty*Ry*Rz]*
% Rx(q3 + ang_err(3))*[Ty*Tz*Rz]*
% Ry(q4 + ang_err(4))*[Tx*Tz*Rz]*
% Rx(q5 + ang_err(5))*[Tz*Rz]*
% Ry(q6) * [Tx*Ty*Tz]

base_err = rand(3:1);
base_err(1) = 0.02;
base_err(2) = 1.23;
base_err(3) = 0.32;
x0 = 0;
y0 = 0;
z0 = 0;
T_base = Tx(x0+ base_err(1))*Ty(y0 + base_err(2))*Tz(z0 + l1 + base_err(3));

tool_err = 1;
T_tool =  Ty(l6 + tool_err+ l5);


%link_err = 1 + 2*rand(8,1);
%ang_err = 1/180*pi + (3/180*pi)*rand(11,1);
params = [0, 1.0526,2.8181,0.0653,0.0270,1.0005,1.002,0.0496,0.0232, ...
    0.0225, 1.7511, 1.4983, 0.0678, 0.0327,2.5668,2.5280,0.0291,...
    0.0562,2.7985,0.0519 
];
Trobot = ...
 Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6));

disp("Base Parameters")
disp(base_err)
disp("Tool Parameters")
disp(tool_err)
disp("Robot Parameters")
disp(params)
params2 = params';
%% result_points_calculation
for i = 1:c
    T_robot = FK(q(i,:),params);
    T = T_base*FK(q(i,:),params)*T_tool;
    result_points(i,:) = T(1:3,4);
end
%% Estimated Parameters for Base and Tool:
Tbase = eye(4);
Ttool = eye(4);
params = zeros(20,1);

%% Step 1
for j = 1 : 20
    Sum_r = zeros(9);
    Sum_p = zeros(9,1);

    for k = 1:30
        dist = [];

        T = FK(q(k,:), params);
        p = T(1:3,4);

        n1 = 3;
        n2 = 9;

        A((n1-2):n1,1:3) = eye(3);
        A((n1-2):n1,4:6) = tildaP(p)';
        A((n1-2):n1, (n2-2):n2) =  T(1:3,1:3);
        dist=[(result_points(i,:)-T(1:3,4)')];

        Sum_r = Sum_r + A' * A;
        Sum_p = Sum_p + A' * dist';
    end

    c = (Sum_r \ Sum_p);

    R = eye(3);
    Tbase = [R, c(1:3); 0, 0, 0, 1];
    pt = R * (c(7:9));
    Ttool = [eye(3),pt; 0, 0, 0, 1];


%% Step 2
J=[];
dist= [];
for i = 1:10
    
    J=[J Jac(q(i,:),params, Tbase, Ttool)'];
    T = Tbase*FK(q(i,:),params)*Ttool;
    p = T(1:3,4);
    dist=[dist (result_points(i,:)-p')];
    
end

J=J';

% rank(J'*J)
del_param = ((J'*J) \ (J'*dist'))';
params = params+del_param;
end
disp(del_param);

%% FK
function T = FK(q,params)
% q - joint state
% params model errors 
    global l2 l4 l3
    T = Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(20) + l3)*Ry(params(7))*Rz(params(8)))* ...
 Rx(q(3) + params(9))* (Ty(params(10))*Tz(params(11) + l4)*Rz(params(12)))* ...
 Ry(q(4) + params(13))* (Tx(params(14))*Tz(params(15))*Rz(params(16)))* ...
 Rx(q(5) + params(17))* (Tz(params(18))*Rz(params(19)))* ...
 Ry(q(6));
end



%%
function J = Jac(q,params,Tbase,Ttool)
% q - joint state
% params model errors 
    global l1 l2 l3 l4 l5 l6
    
    Htx = [0 0 0 1;
    0 0 0 0; 
    0 0 0 0;
    0 0 0 0];
Hty = [0 0 0 0;
    0 0 0 1;
    0 0 0 0; 
    0 0 0 0];
Htz = [0 0 0 0;
    0 0 0 0;
    0 0 0 1;
    0 0 0 0];
Hrx = [0 0 0 0;
    0 0 -1 0;
    0 1 0 0;
    0 0 0 0];
Hry = [0 0 1 0;
    0 0 0 0;
    -1 0 0 0;
    0 0 0 0];
Hrz = [0 -1 0 0;
    1 0 0 0;
    0 0 0 0; 
    0 0 0 0];

J1 = Tbase*Rz(q(1) + params(1))* Hrz* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6)) * Ttool;

J2 = Tbase*Rz(q(1) + params(1))* (Tx(params(2))*Hrx*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;
J3 = Tbase*Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2) *Hty*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J4 = Tbase*Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4))*Hry)* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;



J5 = Tbase*Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5)) * Hrx *(Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;



J6 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Hty*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J7 =Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Htz*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;



J8 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Hry*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J9 =Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9))*Hrz)* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J10 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))*Hrx* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J11 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Hty*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J12 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Htz*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J13 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13))*Hrz)* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J14 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))*Hry* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J15 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Htx*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;


J16 = Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Htz*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J17 =Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17))*Hrz)* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J18 =Tbase* Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))*Hrx* (Tz(params(19))*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J19 = Tbase*Rz(q(1) + params(1))* (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Htz*Rz(params(20)))* ...
 Ry(q(6))*Ttool;

J20 = Tbase*Rz(q(1) + params(1))*  (Tx(params(2))*Ty(params(3) + l2)*Ry(params(4)))* ...
 Rx(q(2) + params(5))* (Ty(params(6))*Tz(params(7) + l3)*Ry(params(8))*Rz(params(9)))* ...
 Rx(q(3) + params(10))* (Ty(params(11))*Tz(params(12) + l4)*Rz(params(13)))* ...
 Ry(q(4) + params(14))* (Tx(params(15))*Tz(params(16))*Rz(params(17)))* ...
 Rx(q(5) + params(18))* (Tz(params(19))*Rz(params(20)))*Hrz* ...
 Ry(q(6))*Ttool;
    
    J = [J1(1:3,4), J2(1:3,4), J3(1:3,4), J4(1:3,4), J5(1:3,4), J6(1:3,4), ...
    J7(1:3,4), J8(1:3,4), J9(1:3,4), J10(1:3,4), J11(1:3,4), J12(1:3,4)...
    J13(1:3,4), J14(1:3,4), J15(1:3,4), J16(1:3,4), J17(1:3, 4), J18(1:3,4), J19(1:3, 4) , J20(1:3,4)
];
end
function P = tildaP(p)
P = [0 -p(3) p(2); p(3) 0 -p(1); -p(2) p(1) 0];
end

